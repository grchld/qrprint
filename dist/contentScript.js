(()=>{"use strict";async function t(t,e="image/png"){const o=await t.convertToBlob({type:e}),n=await o.arrayBuffer(),i=new Uint8Array(n);return`data:${e};base64,`+btoa(String.fromCharCode(...i))}const e=()=>new Promise((t=>requestAnimationFrame(t)));class o{async highlightCanvas(o,n){const i=await t(o);await async function(t,o,n,i){const{top:s,left:r}=i.position,a=i.timeout??3e3,l=document.createElement("img"),{style:h}=l;h.top=s/devicePixelRatio+"px",h.left=r/devicePixelRatio+"px",h.width=o/devicePixelRatio+"px",h.height=n/devicePixelRatio+"px",h.border="0",h.position="fixed",h.zIndex="10000",h.transition=`opacity ${a}ms ease-out`,l.src=t,document.body.appendChild(l),await e(),await e(),l.style.opacity="0",await(t=>new Promise((e=>setTimeout(e,t))))(a),document.body.removeChild(l)}(i,o.width,o.height,n)}async highligtSolid(t,e,o){const{width:n,height:i}=e,s=new OffscreenCanvas(n,i),r=s.getContext("2d");if(!r)throw new Error("No 2d context?");r.fillStyle=t,r.fillRect(0,0,n,i),await this.highlightCanvas(s,o)}}class n{width;height;#t=[];constructor(t){const{width:e,height:o}=t;this.width=e,this.height=o;const n=new OffscreenCanvas(e,o).getContext("2d");if(null==n)throw new Error("No 2d context?");n.drawImage(t,0,0);const i=n.getImageData(0,0,e,o).data;let s=0;const r=[];for(let t=0;t<o;t++){const t=[];r.push(t);for(let o=0;o<e;o++)t.push(.299*i[s]+.587*i[s+1]+.114*i[s+2]<=128),s+=4}this.#t=r}row(t){return this.#t[t]}column(t){return this.#t.map((e=>e[t]))}get(t,e){return this.#t[e][t]}}function i(t){const e=[],o=function(t){let e=!0,o=0;const n=[];for(const i of t)i!==e?(n.push(o),e=i,o=1):o++;return n.push(o),n}(t);for(let t=0,n=0;t<o.length-4;n+=o[t]+o[t+1],t+=2){const i=o[t],s=o[t+1],r=o[t+2],a=o[t+3],l=o[t+4],h=(i+s+r+a+l)/7,c=h/5,f=h-c,d=h+c;h>=4&&h<100&&f<=i&&d>=i&&f<=s&&d>=s&&3*f<=r&&3*d>=r&&f<=a&&d>=a&&f<=l&&d>=l&&e.push({position:n+Math.floor(3.5*h),size:h})}return e}const s=(t,e)=>5*Math.abs(t-e)<t+e,r=(t,e)=>`${t}|${e}`;function a(t,e){const{top:o,left:n,bottom:i,right:s,size:r}=e;let a=0;const l=(s-n)/r,h=(i-o)/r,c=[];for(let e=0;e<r;e++){const i=[];c.push(i);const s=Math.ceil(o+h*e)+1,f=Math.floor(s+h)-1;for(let e=0;e<r;e++){const o=Math.ceil(n+l*e)+1,r=Math.floor(o+l)-1;let h=0,c=0;for(let e=s;e<f;e++)for(let n=o;n<r;n++)c++,t.get(n,e)&&h++;2*h>c?(i.push(!0),a=Math.max(a,(c-h)/c)):(i.push(!1),a=Math.max(a,h/c))}}return{threshold:a,modules:c}}function l(t){const e=[];for(let o=0;o<t.height;o++)e.push(...i(t.row(o)).map((({position:t,size:e})=>({x:t,y:o,size:e}))));const o=[];for(let e=0;e<t.width;e++)o.push(...i(t.column(e)).map((({position:t,size:o})=>({x:e,y:t,size:o}))));const n=function(t){const e=[];[...t].sort(((t,e)=>t.x-e.x+2*(t.y-e.y)));for(let o=0;o<t.length-2;o++){const n=t[o],i=n.size,r=i/5;for(let a=o+1;a<t.length-1;a++){const o=t[a],l=o.x-n.x;if(!(l<10*i||Math.abs(o.y-n.y)>r)&&s(o.size,n.size))for(let h=a+1;h<t.length;h++){const a=t[h],c=a.y-n.y;if(c<10*i||Math.abs(a.x-n.x)>r||!s(a.size,n.size)||!s(c,l))continue;const f=Math.round(l/i)+7;f===Math.round(c/i)+7&&e.push({top:n.y-3.5*i,left:n.x-3.5*i,bottom:a.y+3.5*a.size,right:o.x+3.5*o.size,size:f})}}}return e}(function(t,e){const o=new Map;for(const{x:i,y:a,size:l}of t)for(const{x:t,y:h,size:c}of e)Math.abs(i-t)<=2&&Math.abs(a-h)<=2&&s(l,c)&&(({x:t,y:e,size:n})=>{const i=Math.ceil(n);for(let n=-i;n<=i;n++)for(let s=-i;s<=i;s++)if(null!=o.get(r(t+n,e+s)))return!1;return!0})(n={x:i,y:h,size:(l+c)/2})&&o.set(r(n.x,n.y),n);var n;return Array.from(o.values())}(e,o));return n.map((e=>function(t,e){let o=e,{modules:n,threshold:i}=a(t,e);console.log(`Initial threshold ${i} ${o.left}-${o.right}x${o.top}-${o.bottom}`);const s=e=>{let s=!1;for(const r of e){const{threshold:e,modules:l}=a(t,r);e<i&&(o=r,n=l,i=e,console.log(` better threshold ${i} ${o.left}-${o.right}x${o.top}-${o.bottom}`),s=!0)}return s};let r=5;for(;r>0&&s([-1,-.5,.5,1].flatMap((t=>[{...o,top:o.top+t},{...o,bottom:o.bottom+t},{...o,left:o.left+t},{...o,right:o.right+t}])));)r--;const l=i<=.25;return l||console.log("%c%s","color:red",`Unclear QR with threshold ${i}`),{valid:l,modules:n,grid:o}}(t,e)))}async function h(e){const i=await async function(t){const[e,o]=t.split(","),n=function(t){const e=atob(t),{length:o}=e,n=new Uint8Array(o);for(let t=0;t<o;t++)n[t]=e.charCodeAt(t);return n.buffer}(o),i=new Blob([n],{type:e});return await createImageBitmap(i)}(e),s=l(new n(i));!function(t){const e=new o;for(const{valid:o,grid:{top:n,left:i,bottom:s,right:r}}of t)e.highligtSolid(o?"#00ff00a0":"#ff0000a0",{width:r-i+1,height:s-n+1},{position:{top:n,left:i}})}(s);const[r]=s;r&&r.valid&&async function(e){const o=new OffscreenCanvas(448,448);!function(t,e){const o=t.length,n=e.getContext("2d");if(!n)throw new Error("No 2d context for QR?");n.fillStyle="white",n.fillRect(0,0,e.width,e.height);const i=Math.floor(Math.min(e.width,e.height)/o),s=Math.floor((e.width-i*o)/2),r=Math.floor((e.height-i*o)/2);for(let e=0;e<o;e++)for(let a=0;a<o;a++)n.fillStyle=t[e][a]?"black":"white",n.fillRect(s+i*a,r+i*e,i,i)}(e,o),async function(t,e,o){const n=document.createElement("iframe"),{style:i}=n;i.display="hidden",i.top="0",i.left="0",i.width=e,i.height=o,i.border="0",n.onload=()=>{const t=()=>document.body.removeChild(n),{contentWindow:e}=n;e&&(e.onbeforeunload=t,e.onafterprint=t,e.print())},n.srcdoc=`\n    <html>\n    <head>\n    <style>    \n    html, body, img {\n        border: 0;\n        height: ${o};\n        margin: 0;\n        overflow: hidden;\n        padding: 0;\n        width: ${e};\n    }\n    </style>\n    </head>\n    <body>\n    <img src="${t}"/>\n    </body>\n    </html>\n    `,document.body.appendChild(n)}(await t(o),"2.25in","2.25in")}(r.modules)}chrome.runtime.onMessage.hasListeners()?console.log("Content script is already loaded"):chrome.runtime.onMessage.addListener((function t(e,o,n){switch(e.type){case"detect":return h(e.dataUrl).then(n),!0;case"close":chrome.runtime.onMessage.removeListener(t)}return!1}))})();
//# sourceMappingURL=contentScript.js.map