(()=>{"use strict";class t{injector;constructor(t){this.injector=t}async print(t,e,n){await this.injector.inject(o,t,e,n)}}async function o(t,o,e){const n=document.createElement("iframe"),{style:i}=n;i.display="hidden",i.top="0",i.left="0",i.width=o,i.height=e,i.border="0",n.onload=()=>{const t=()=>document.body.removeChild(n),{contentWindow:o}=n;o&&(o.onbeforeunload=t,o.onafterprint=t,o.print())},n.srcdoc=`\n    <html>\n    <head>\n    <style>    \n    body {\n        background-image: url("${t}");\n        background-size: contain;\n        background-repeat: no-repeat;\n        height: ${e};\n        margin: 0;\n        overflow: hidden;\n        width: ${o};\n    }\n    </style>\n    </head>\n    <body>\n    </body>\n    </html>\n    `,document.body.appendChild(n)}class e{width;height;#t=[];constructor(t){const{width:o,height:e}=t;this.width=o,this.height=e;const n=new OffscreenCanvas(o,e).getContext("2d");if(null==n)throw new Error("No 2d context?");n.drawImage(t,0,0);const i=n.getImageData(0,0,o,e).data;let r=0;const s=[];for(let t=0;t<e;t++){const t=[];s.push(t);for(let e=0;e<o;e++)t.push(.299*i[r]+.587*i[r+1]+.114*i[r+2]<=128),r+=4}this.#t=s}row(t){return this.#t[t]}column(t){return this.#t.map((o=>o[t]))}get(t,o){return this.#t[o][t]}}async function n(t,o="image/png"){const e=await t.convertToBlob({type:o}),n=await e.arrayBuffer(),i=new Uint8Array(n);return`data:${o};base64,`+btoa(String.fromCharCode(...i))}function i(t){const o=[],e=function(t){let o=!0,e=0;const n=[];for(const i of t)i!==o?(n.push(e),o=i,e=1):e++;return n.push(e),n}(t);for(let t=0,n=0;t<e.length-4;n+=e[t]+e[t+1],t+=2){const i=e[t],r=e[t+1],s=e[t+2],a=e[t+3],c=e[t+4],l=(i+r+s+a+c)/7,h=l/5,f=l-h,d=l+h;l>=4&&l<100&&f<=i&&d>=i&&f<=r&&d>=r&&3*f<=s&&3*d>=s&&f<=a&&d>=a&&f<=c&&d>=c&&o.push({position:n+Math.floor(3.5*l),size:l})}return o}const r=(t,o)=>5*Math.abs(t-o)<t+o,s=(t,o)=>`${t}|${o}`;function a(t,o){const{top:e,left:n,bottom:i,right:r,size:s}=o;let a=0;const c=(r-n)/s,l=(i-e)/s,h=[];for(let o=0;o<s;o++){const i=[];h.push(i);const r=Math.ceil(e+l*o)+1,f=Math.floor(r+l)-1;for(let o=0;o<s;o++){const e=Math.ceil(n+c*o)+1,s=Math.floor(e+c)-1;let l=0,h=0;for(let o=r;o<f;o++)for(let n=e;n<s;n++)h++,t.get(n,o)&&l++;2*l>h?(i.push(!0),a=Math.max(a,(h-l)/h)):(i.push(!1),a=Math.max(a,l/h))}}return{threshold:a,modules:h}}function c(t){const o=[];for(let e=0;e<t.height;e++)o.push(...i(t.row(e)).map((({position:t,size:o})=>({x:t,y:e,size:o}))));const e=[];for(let o=0;o<t.width;o++)e.push(...i(t.column(o)).map((({position:t,size:e})=>({x:o,y:t,size:e}))));const n=function(t){const o=[];[...t].sort(((t,o)=>t.x-o.x+2*(t.y-o.y)));for(let e=0;e<t.length-2;e++){const n=t[e],i=n.size,s=i/5;for(let a=e+1;a<t.length-1;a++){const e=t[a],c=e.x-n.x;if(!(c<10*i||Math.abs(e.y-n.y)>s)&&r(e.size,n.size))for(let l=a+1;l<t.length;l++){const a=t[l],h=a.y-n.y;if(h<10*i||Math.abs(a.x-n.x)>s||!r(a.size,n.size)||!r(h,c))continue;const f=Math.round(c/i)+7;f===Math.round(h/i)+7&&o.push({top:n.y-3.5*i,left:n.x-3.5*i,bottom:a.y+3.5*a.size,right:e.x+3.5*e.size,size:f})}}}return o}(function(t,o){const e=new Map;for(const{x:i,y:a,size:c}of t)for(const{x:t,y:l,size:h}of o)Math.abs(i-t)<=2&&Math.abs(a-l)<=2&&r(c,h)&&(({x:t,y:o,size:n})=>{const i=Math.ceil(n);for(let n=-i;n<=i;n++)for(let r=-i;r<=i;r++)if(null!=e.get(s(t+n,o+r)))return!1;return!0})(n={x:i,y:l,size:(c+h)/2})&&e.set(s(n.x,n.y),n);var n;return Array.from(e.values())}(o,e));return n.map((o=>function(t,o){let e=o,{modules:n,threshold:i}=a(t,o);console.log(`Initial threshold ${i} ${e.left}-${e.right}x${e.top}-${e.bottom}`);const r=o=>{let r=!1;for(const s of o){const{threshold:o,modules:c}=a(t,s);o<i&&(e=s,n=c,i=o,console.log(` better threshold ${i} ${e.left}-${e.right}x${e.top}-${e.bottom}`),r=!0)}return r};let s=5;for(;s>0&&r([-1,-.5,.5,1].flatMap((t=>[{...e,top:e.top+t},{...e,bottom:e.bottom+t},{...e,left:e.left+t},{...e,right:e.right+t}])));)s--;const c=i<=.25;return c||console.log("%c%s","color:red",`Unclear QR with threshold ${i}`),{valid:c,modules:n,grid:e}}(t,o)))}class l{tabId;constructor(t){this.tabId=t}async inject(t,...o){const e=await chrome.scripting.executeScript({target:{tabId:this.tabId},func:t,args:o});return await(e[0]?.result)}}class h{contentInjector;constructor(t){this.contentInjector=t}async highlightCanvas(t,o){const e=await n(t);await this.contentInjector.inject(f,e,t.width,t.height,o)}async highligtSolid(t,o,e){const{width:n,height:i}=o,r=new OffscreenCanvas(n,i),s=r.getContext("2d");if(!s)throw new Error("No 2d context?");s.fillStyle=t,s.fillRect(0,0,n,i),await this.highlightCanvas(r,e)}}async function f(t,o,e,n){const i=()=>new Promise((t=>requestAnimationFrame(t))),{top:r,left:s}=n.position,a=n.timeout??3e3,c=document.createElement("img"),{style:l}=c;l.top=r/devicePixelRatio+"px",l.left=s/devicePixelRatio+"px",l.width=o/devicePixelRatio+"px",l.height=e/devicePixelRatio+"px",l.border="0",l.position="fixed",l.zIndex="10000",l.transition=`opacity ${a}ms ease-out`,c.src=t,document.body.appendChild(c),await i(),await i(),c.style.opacity="0",await(t=>new Promise((o=>setTimeout(o,t))))(a),document.body.removeChild(c)}chrome.action.onClicked.addListener((function(o){chrome.tabs.captureVisibleTab({format:"png"},(async i=>{const r=o.id;if(null==r)return void console.error("No tab id");const s=new l(r),a=await async function(t){const[o,e]=t.split(","),n=function(t){const o=atob(t),{length:e}=o,n=new Uint8Array(e);for(let t=0;t<e;t++)n[t]=o.charCodeAt(t);return n.buffer}(e),i=new Blob([n],{type:o});return await createImageBitmap(i)}(i),f=c(new e(a));!function(t,o){const e=new h(t);for(const{valid:t,grid:{top:n,left:i,bottom:r,right:s}}of o)e.highligtSolid(t?"#00ff00a0":"#ff0000a0",{width:s-i+1,height:r-n+1},{position:{top:n,left:i}})}(s,f);const[d]=f;d&&d.valid&&async function(o,e){const i=new OffscreenCanvas(192,192);!function(t,o){const e=t.length,n=o.getContext("2d");if(!n)throw new Error("No 2d context for QR?");const i=Math.floor(Math.min(o.width,o.height)/e),r=Math.floor((o.width-i*e)/2),s=Math.floor((o.height-i*e)/2);for(let o=0;o<e;o++)for(let a=0;a<e;a++)n.fillStyle=t[o][a]?"black":"white",n.fillRect(r+i*a,s+i*o,i,i)}(e,i);const r=await n(i);new t(o).print(r,"2.25in","2.25in")}(s,d.modules)}))}))})();
//# sourceMappingURL=background.js.map